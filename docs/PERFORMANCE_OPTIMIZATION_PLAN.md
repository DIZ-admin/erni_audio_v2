# üöÄ –ü–ª–∞–Ω –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ Erni_audio_v2

## üìä –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è (2025-06-01)

### –í—ã—è–≤–ª–µ–Ω–Ω—ã–µ —É–∑–∫–∏–µ –º–µ—Å—Ç–∞
–ù–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∞–π–ª–∞ "Sitzung Erweiterte GL 17.04.2025.m4a" (214MB, 140 –º–∏–Ω—É—Ç):

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –í—Ä–µ–º—è | –î–æ–ª—è | –ü—Ä–æ–±–ª–µ–º–∞ |
|-----------|-------|------|----------|
| **OpenAI API retry** | 27 –º–∏–Ω 48 —Å–µ–∫ | 70% | –ù–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å API, –ø—Ä–æ—Å—Ç—ã–µ retry |
| **Rate limiting** | 6 –º–∏–Ω 6 —Å–µ–∫ | 15% | –ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ –ª–∏–º–∏—Ç–æ–≤ –∑–∞–ø—Ä–æ—Å–æ–≤ |
| **–°–µ—Ç–µ–≤—ã–µ –∑–∞–¥–µ—Ä–∂–∫–∏** | 4 –º–∏–Ω | 10% | –ó–∞–≥—Ä—É–∑–∫–∞ –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤ |
| **Overhead —Ä–∞–∑–±–∏–µ–Ω–∏—è** | 2 –º–∏–Ω | 5% | –û–±—Ä–∞–±–æ—Ç–∫–∞ 14 —á–∞—Å—Ç–µ–π |
| **–ò—Ç–æ–≥–æ** | **39 –º–∏–Ω 54 —Å–µ–∫** | 100% | –í–º–µ—Å—Ç–æ –æ–∂–∏–¥–∞–µ–º—ã—Ö 14 –º–∏–Ω—É—Ç |

### –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã API

#### pyannote.ai API
- **–§–æ—Ä–º–∞—Ç—ã**: mp3, wav, m4a, ogg, flac
- **–õ–∏–º–∏—Ç—ã**: –¥–æ 1GB (–¥–∏–∞—Ä–∏–∑–∞—Ü–∏—è), –¥–æ 100MB (voiceprints)
- **–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: –¥–æ 24 —á–∞—Å–æ–≤ (–¥–∏–∞—Ä–∏–∑–∞—Ü–∏—è), –¥–æ 30 —Å–µ–∫—É–Ω–¥ (voiceprints)

#### OpenAI Whisper API
- **–§–æ—Ä–º–∞—Ç—ã**: m4a, mp3, webm, mp4, mpga, wav, mpeg
- **–õ–∏–º–∏—Ç—ã**: –¥–æ 25MB –Ω–∞ —Ñ–∞–π–ª
- **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏**: 16kHz mono WAV, 128-256 kbps

## üéØ –ü–ª–∞–Ω –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### –§–∞–∑–∞ 1: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —É–ª—É—á—à–µ–Ω–∏—è (–ò—é–ª—å 2025)

#### 1.1 –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ OpenAI API
**–¶–µ–ª—å**: –°–Ω–∏–∂–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ retry –Ω–∞ 62% (—Å 27 –º–∏–Ω –¥–æ 10 –º–∏–Ω)

```python
# –¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è (–ø—Ä–æ–±–ª–µ–º–Ω–∞—è)
def simple_retry():
    for attempt in range(3):
        try:
            return api_call()
        except Exception:
            time.sleep(1)  # –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞

# –ù–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è (–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è)
def exponential_backoff_retry():
    max_retries = 5
    base_delay = 1.0
    
    for attempt in range(max_retries):
        try:
            return api_call()
        except openai.RateLimitError as e:
            if attempt < max_retries - 1:
                delay = base_delay * (2 ** attempt) + random.uniform(0, 1)
                logger.warning(f"Rate limit hit, retrying in {delay:.2f}s...")
                time.sleep(delay)
            else:
                raise
        except openai.APIConnectionError as e:
            # –ë—ã—Å—Ç—Ä—ã–π retry –¥–ª—è —Å–µ—Ç–µ–≤—ã—Ö –æ—à–∏–±–æ–∫
            if attempt < 2:
                time.sleep(0.5)
                continue
            raise
```

**–ó–∞–¥–∞—á–∏**:
- [ ] –†–µ–∞–ª–∏–∑–∞—Ü–∏—è exponential backoff —Å jitter
- [ ] –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–æ–≤ –æ—à–∏–±–æ–∫
- [ ] –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ —Ç–∞–π–º–∞—É—Ç—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞
- [ ] –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ retry

#### 1.2 –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —á–∞—Å—Ç–µ–π —Ñ–∞–π–ª–æ–≤
**–¶–µ–ª—å**: –£—Å–∫–æ—Ä–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –Ω–∞ 47%

```python
async def parallel_transcription(chunks: List[Path]) -> List[Dict]:
    """–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–æ 3 —á–∞—Å—Ç–µ–π –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ"""
    semaphore = asyncio.Semaphore(3)  # –õ–∏–º–∏—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
    
    async def process_chunk(chunk_path, offset):
        async with semaphore:
            return await transcribe_chunk_async(chunk_path, offset)
    
    tasks = [process_chunk(chunk, i*600) for i, chunk in enumerate(chunks)]
    results = await asyncio.gather(*tasks, return_exceptions=True)
    
    return merge_chunk_results(results)
```

**–ó–∞–¥–∞—á–∏**:
- [ ] –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–æ 3 —á–∞—Å—Ç–µ–π –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
- [ ] –°–µ–º–∞—Ñ–æ—Ä—ã –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ OpenAI API
- [ ] –û—á–µ—Ä–µ–¥—å –∑–∞–¥–∞—á —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º–∏
- [ ] –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏

### –§–∞–∑–∞ 2: –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è (–ê–≤–≥—É—Å—Ç 2025)

#### 2.1 –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ä–∞–∑–±–∏–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤
**–¶–µ–ª—å**: –£–ª—É—á—à–µ–Ω–∏–µ –Ω–∞ 25%

```python
def smart_split_audio(wav_local: Path) -> List[Path]:
    """–†–∞–∑–±–∏–µ–Ω–∏–µ —Å —É—á–µ—Ç–æ–º –ø–∞—É–∑ –≤ —Ä–µ—á–∏"""
    audio = AudioSegment.from_wav(wav_local)
    
    # –î–µ—Ç–µ–∫—Ü–∏—è –ø–∞—É–∑ –¥–ª—è –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Ä–∞–∑–±–∏–µ–Ω–∏—è
    silence_thresh = audio.dBFS - 16
    chunks = split_on_silence(
        audio,
        min_silence_len=2000,  # 2 —Å–µ–∫—É–Ω–¥—ã —Ç–∏—à–∏–Ω—ã
        silence_thresh=silence_thresh,
        keep_silence=500  # –°–æ—Ö—Ä–∞–Ω–∏—Ç—å 0.5—Å —Ç–∏—à–∏–Ω—ã
    )
    
    return optimize_chunk_sizes(chunks, target_size_mb=20)
```

**–ó–∞–¥–∞—á–∏**:
- [ ] –£–º–Ω–æ–µ —Ä–∞–∑–±–∏–µ–Ω–∏–µ –ø–æ –ø–∞—É–∑–∞–º –≤ —Ä–µ—á–∏ (silence detection)
- [ ] –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ä–∞–∑–º–µ—Ä —á–∞—Å—Ç–µ–π (15-20MB –≤–º–µ—Å—Ç–æ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö 10 –º–∏–Ω—É—Ç)
- [ ] –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏
- [ ] –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è –º–∏–Ω–∏–º–∏–∑–∞—Ü–∏–∏ overhead

#### 2.2 –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
**–¶–µ–ª—å**: 80% cache hit rate

```python
def cache_key(file_path: Path, params: Dict) -> str:
    """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª—é—á–∞ –∫—ç—à–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ö—ç—à–∞ —Ñ–∞–π–ª–∞ –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤"""
    file_hash = hashlib.sha256(file_path.read_bytes()).hexdigest()[:16]
    params_hash = hashlib.md5(json.dumps(params, sort_keys=True).encode()).hexdigest()[:8]
    return f"transcription:{file_hash}:{params_hash}"

async def cached_transcription(file_path: Path, params: Dict) -> Dict:
    """–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º"""
    cache_key_str = cache_key(file_path, params)
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—ç—à–∞
    cached_result = await redis_client.get(cache_key_str)
    if cached_result:
        return json.loads(cached_result)
    
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –∫—ç—à
    result = await transcribe_file(file_path, params)
    await redis_client.setex(cache_key_str, 86400, json.dumps(result))  # TTL 24—á
    
    return result
```

### –§–∞–∑–∞ 3: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –º–µ—Ç—Ä–∏–∫–∏ (–°–µ–Ω—Ç—è–±—Ä—å 2025)

#### 3.1 Prometheus –º–µ—Ç—Ä–∏–∫–∏
```python
# –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
TRANSCRIPTION_DURATION = Histogram(
    'transcription_duration_seconds',
    'Time spent on transcription',
    ['model', 'file_size_mb']
)

API_RETRY_COUNT = Counter(
    'api_retry_total',
    'Total API retry attempts',
    ['api_provider', 'error_type']
)

PARALLEL_PROCESSING_EFFICIENCY = Gauge(
    'parallel_processing_efficiency',
    'Efficiency of parallel processing (0-1)'
)
```

#### 3.2 –ê–ª–µ—Ä—Ç–∏–Ω–≥
- –ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ > 0.2x –æ—Ç –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∞—É–¥–∏–æ
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ retry > 5 –¥–ª—è –æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
- Cache hit rate < 60%
- API error rate > 5%

## üìà –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
| –ú–µ—Ç—Ä–∏–∫–∞ | –¢–µ–∫—É—â–µ–µ | –ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ | –£–ª—É—á—à–µ–Ω–∏–µ |
|---------|---------|-------------------|-----------|
| **–í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏** | 42 –º–∏–Ω (0.3x) | 6 –º–∏–Ω (0.05x) | **85% –±—ã—Å—Ç—Ä–µ–µ** |
| **API retry –≤—Ä–µ–º—è** | 27 –º–∏–Ω (70%) | 4 –º–∏–Ω (10%) | **62% –±—ã—Å—Ç—Ä–µ–µ** |
| **–ü–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º** | 1 —á–∞—Å—Ç—å | 3 —á–∞—Å—Ç–∏ | **47% –±—ã—Å—Ç—Ä–µ–µ** |
| **–£–º–Ω–æ–µ —Ä–∞–∑–±–∏–µ–Ω–∏–µ** | –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ | –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ | **25% –±—ã—Å—Ç—Ä–µ–µ** |

### –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å
- **API error rate**: 5% ‚Üí 1%
- **Retry success rate**: 85% ‚Üí 95%
- **Cache hit rate**: 0% ‚Üí 80%
- **Uptime**: 95% ‚Üí 99.5%

## üõ†Ô∏è –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏

### –ù–æ–≤—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
```bash
pip install redis asyncio aiohttp pydub
```

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
```yaml
# config/performance.yaml
retry:
  max_attempts: 5
  base_delay: 1.0
  max_delay: 60.0
  jitter: true

parallel:
  max_concurrent_chunks: 3
  semaphore_timeout: 300

cache:
  redis_url: "redis://localhost:6379"
  ttl_seconds: 86400
  max_memory: "2gb"

splitting:
  target_size_mb: 20
  silence_threshold_db: -16
  min_silence_ms: 2000
```

## üìã –ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏

### –î–ª—è –∫–∞–∂–¥–æ–π —Ñ–∞–∑—ã:
- [ ] –ö–æ–¥ –Ω–∞–ø–∏—Å–∞–Ω –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω
- [ ] Performance —Ç–µ—Å—Ç—ã –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –æ–∂–∏–¥–∞–µ–º—ã–µ —É–ª—É—á—à–µ–Ω–∏—è
- [ ] Backward compatibility —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞
- [ ] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞
- [ ] –ú–µ—Ç—Ä–∏–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –∏ —Ä–∞–±–æ—Ç–∞—é—Ç

### –î–ª—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Ä–µ–ª–∏–∑–∞:
- [ ] –û–±—â–µ–µ —É—Å–∫–æ—Ä–µ–Ω–∏–µ > 80%
- [ ] API retry –≤—Ä–µ–º—è < 15% –æ—Ç –æ–±—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
- [ ] Cache hit rate > 70%
- [ ] –í—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç
- [ ] –ù–æ–≤—ã–µ performance —Ç–µ—Å—Ç—ã –¥–æ–±–∞–≤–ª–µ–Ω—ã

---

*–î–æ–∫—É–º–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω: 2025-06-01*
*–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π: Development Team*
*–°–ª–µ–¥—É—é—â–∏–π –æ–±–∑–æ—Ä: 2025-07-01*
